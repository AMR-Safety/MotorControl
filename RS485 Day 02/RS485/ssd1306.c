#include "ssd1306.h"
#include <string.h>

static uint8_t buffer[1024];

void ssd1306_command(uint8_t cmd) {
	twi_start();
	twi_write(SSD1306_ADDR << 1);
	twi_write(0x00);  // Command mode
	twi_write(cmd);
	twi_stop();
}

void ssd1306_init(void) {
	_delay_ms(100);
	ssd1306_command(0xAE); // Display off
	ssd1306_command(0xD5); ssd1306_command(0x80);
	ssd1306_command(0xA8); ssd1306_command(0x3F);
	ssd1306_command(0xD3); ssd1306_command(0x00);
	ssd1306_command(0x40);
	ssd1306_command(0x8D); ssd1306_command(0x14);
	ssd1306_command(0x20); ssd1306_command(0x00);
	ssd1306_command(0xA1);
	ssd1306_command(0xC8);
	ssd1306_command(0xDA); ssd1306_command(0x12);
	ssd1306_command(0x81); ssd1306_command(0xCF);
	ssd1306_command(0xD9); ssd1306_command(0xF1);
	ssd1306_command(0xDB); ssd1306_command(0x40);
	ssd1306_command(0xA4);
	ssd1306_command(0xA6);
	ssd1306_command(0xAF); // Display on
	ssd1306_clear();
	ssd1306_display();
}

void ssd1306_clear(void) {
	memset(buffer, 0x00, sizeof(buffer));
}

void ssd1306_display(void) {
	for (uint8_t page = 0; page < 8; page++) {
		ssd1306_command(0xB0 + page);
		ssd1306_command(0x00);
		ssd1306_command(0x10);
		twi_start();
		twi_write(SSD1306_ADDR << 1);
		twi_write(0x40); // Data stream
		for (uint8_t i = 0; i < 128; i++) {
			twi_write(buffer[page * 128 + i]);
		}
		twi_stop();
	}
}

void ssd1306_set_cursor(uint8_t col, uint8_t row) {
	ssd1306_command(0xB0 + row);
	ssd1306_command(0x00 + (col & 0x0F));
	ssd1306_command(0x10 + ((col >> 4) & 0x0F));
}

extern const uint8_t font5x7[][5];

void ssd1306_write_char(char c) {
	if (c < 32 || c > 126) c = '?';
	uint8_t index = c - 32;
	twi_start();
	twi_write(SSD1306_ADDR << 1);
	twi_write(0x40);
	for (uint8_t i = 0; i < 5; i++) {
		twi_write(font5x7[index][i]);
	}
	twi_write(0x00); // space between characters
	twi_stop();
}

void ssd1306_print(const char* str) {
	while (*str) {
		ssd1306_write_char(*str++);
	}
}

// Simple font 5x7 (only space to '9' for brevity)
const uint8_t font5x7[][5] = {
	{0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x5F,0x00,0x00}, {0x00,0x07,0x00,0x07,0x00},
	{0x14,0x7F,0x14,0x7F,0x14}, {0x24,0x2A,0x7F,0x2A,0x12}, {0x23,0x13,0x08,0x64,0x62},
	{0x36,0x49,0x55,0x22,0x50}, {0x00,0x05,0x03,0x00,0x00}, {0x00,0x1C,0x22,0x41,0x00},
	{0x00,0x41,0x22,0x1C,0x00}, {0x14,0x08,0x3E,0x08,0x14}, {0x08,0x08,0x3E,0x08,0x08},
	{0x00,0x50,0x30,0x00,0x00}, {0x08,0x08,0x08,0x08,0x08}, {0x00,0x60,0x60,0x00,0x00},
	{0x20,0x10,0x08,0x04,0x02}, {0x3E,0x51,0x49,0x45,0x3E}, {0x00,0x42,0x7F,0x40,0x00},
	{0x42,0x61,0x51,0x49,0x46}, {0x21,0x41,0x45,0x4B,0x31}, {0x18,0x14,0x12,0x7F,0x10},
	{0x27,0x45,0x45,0x45,0x39}, {0x3C,0x4A,0x49,0x49,0x30}, {0x01,0x71,0x09,0x05,0x03},
	{0x36,0x49,0x49,0x49,0x36}, {0x06,0x49,0x49,0x29,0x1E}
};
